# 01. Claude Code 整体架构设计

## 目录
- [1.1 核心架构模式](#11-核心架构模式)
- [1.2 主要组件交互](#12-主要组件交互)
- [1.3 工具系统设计](#13-工具系统设计)
- [1.4 权限管理策略](#14-权限管理策略)
- [1.5 架构设计理念](#15-架构设计理念)

---

## 1.1 核心架构模式

Claude Code 采用了 **代理-子代理分层架构（Agent-Subagent Hierarchical Architecture）**，实现了一个多智能体协作系统。

### 架构层级

```
┌─────────────────────────────────────────────────────────┐
│                    用户交互层                            │
│  CLI / VS Code / IDE / Web Interface                    │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    主代理层                              │
│  ┌──────────────┐              ┌──────────────┐         │
│  │ Build Agent  │              │ Plan Agent   │         │
│  │ (执行模式)   │              │ (规划模式)   │         │
│  └──────────────┘              └──────────────┘         │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    任务协调层                            │
│              Task System (跨会话持久化)                  │
│  ┌──────────┬──────────┬──────────┬──────────┐          │
│  │ TaskCreate│TaskUpdate│TaskList  │TaskGet   │          │
│  └──────────┴──────────┴──────────┴──────────┘          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    子代理层                              │
│  ┌───────────┐    ┌───────────┐    ┌───────────┐       │
│  │ Explore   │    │ General   │    │ Bash      │       │
│  │ Subagent  │    │ Subagent  │    │ Subagent  │       │
│  │ (只读)    │    │ (全功能)  │    │ (命令行)  │       │
│  └───────────┘    └───────────┘    └───────────┘       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    工具执行层                            │
│  ┌──────────────────────────────────────────────┐       │
│  │ 内置工具: File, Bash, Git, Task, Web...     │       │
│  └──────────────────────────────────────────────┘       │
│  ┌──────────────────────────────────────────────┐       │
│  │ MCP 工具: Database, API, Design Tools...    │       │
│  └──────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                    执行环境层                            │
│  文件系统 │ 命令行 │ Git 仓库 │ 外部服务                │
└─────────────────────────────────────────────────────────┘
```

### 关键特性

1. **分层责任**
   - 主代理：高级决策、任务分解、用户交互
   - 子代理：专门任务、并行执行、独立上下文
   - 任务系统：跨会话协调、持久化状态、依赖管理

2. **职责分离**
   - Build Agent：直接执行代码修改和命令
   - Plan Agent：分析和规划，不执行破坏性操作
   - Subagents：专门化处理特定类型任务

3. **扩展性**
   - MCP 协议支持外部工具集成
   - Skills 系统允许自定义行为
   - Hook 系统实现工作流自动化

---

## 1.2 主要组件交互

### 组件关系图

```
┌──────────────────────────────────────────────────────────┐
│                     Claude Code CLI                       │
│                                                           │
│  ┌────────────────────────────────────────────────┐      │
│  │              Session Manager                    │      │
│  │  ├─ 上下文管理 (Context Window)                │      │
│  │  ├─ 对话历史 (Conversation History)            │      │
│  │  └─ 会话恢复 (Resume/Teleport)                 │      │
│  └────────────────────────────────────────────────┘      │
│                          ↓                                │
│  ┌─────────────────┐              ┌─────────────────┐    │
│  │  Build Agent    │◄─────────────┤  Plan Agent     │    │
│  │                 │  审批后切换   │                 │    │
│  │  权限: 完整     │              │  权限: 只读      │    │
│  │  模式: 执行     │              │  模式: 分析      │    │
│  └─────────────────┘              └─────────────────┘    │
│         │                                  │              │
│         │          Task Coordination       │              │
│         └──────────────┬──────────────────┘              │
│                        ↓                                  │
│  ┌────────────────────────────────────────────────┐      │
│  │           Task System (持久化)                  │      │
│  │  ┌──────────────────────────────────────────┐  │      │
│  │  │  Task Graph (有向无环图 DAG)             │  │      │
│  │  │  ├─ Task 1 → Task 2 → Task 5            │  │      │
│  │  │  ├─ Task 3 → Task 4 ┘                   │  │      │
│  │  │  └─ blockedBy / blocking 依赖管理        │  │      │
│  │  └──────────────────────────────────────────┘  │      │
│  │                                                 │      │
│  │  存储位置: ~/.claude/tasks/                     │      │
│  │  跨会话共享: CLAUDE_CODE_TASK_LIST_ID 环境变量  │      │
│  └────────────────────────────────────────────────┘      │
│                        ↓                                  │
│  ┌─────────┐      ┌─────────┐      ┌─────────┐          │
│  │Explore  │      │General  │      │  Bash   │          │
│  │SubAgent │      │SubAgent │      │SubAgent │          │
│  │         │      │         │      │         │          │
│  │只读探索 │      │完整权限 │      │命令执行 │          │
│  └─────────┘      └─────────┘      └─────────┘          │
│      │                 │                 │               │
│      └─────────────────┴─────────────────┘               │
│                        ↓                                  │
│  ┌────────────────────────────────────────────────┐      │
│  │         Tool Execution Engine                   │      │
│  │  ├─ Permission Manager (权限检查)               │      │
│  │  ├─ Hook System (前置/后置钩子)                │      │
│  │  └─ Result Aggregator (结果聚合)               │      │
│  └────────────────────────────────────────────────┘      │
│                        ↓                                  │
│  ┌────────────────────────────────────────────────┐      │
│  │           MCP Integration Layer                 │      │
│  │  ├─ Local MCP Servers                          │      │
│  │  ├─ Remote MCP Servers                         │      │
│  │  └─ MCP Apps (Interactive UI)                  │      │
│  └────────────────────────────────────────────────┘      │
│                                                           │
└──────────────────────────────────────────────────────────┘
```

### 交互流程

#### 典型工作流程

```
1. 用户输入请求
   │
   ↓
2. Session Manager 解析意图
   │
   ├─→ 需要规划? → Plan Agent
   │   ├─ 使用 Explore Subagent 分析代码库
   │   ├─ 生成实现计划
   │   ├─ 等待用户审批
   │   └─ 切换到 Build Agent
   │
   └─→ 直接执行? → Build Agent
       │
       ↓
3. 任务分解 (Task Decomposition)
   │
   ├─ TaskCreate: Task 1 (依赖: 无)
   ├─ TaskCreate: Task 2 (依赖: Task 1)
   ├─ TaskCreate: Task 3 (依赖: Task 1)
   └─ TaskCreate: Task 4 (依赖: Task 2, Task 3)
   │
   ↓
4. 并行调度 (Parallel Scheduling)
   │
   ├─ Task 1 → General Subagent #1 (立即执行)
   │   └─ 完成后唤醒 Task 2 和 Task 3
   │
   ├─ Task 2 → Explore Subagent #1 (等待 Task 1)
   │   └─ 完成后唤醒 Task 4
   │
   ├─ Task 3 → Bash Subagent #1 (等待 Task 1)
   │   └─ 完成后唤醒 Task 4
   │
   └─ Task 4 → General Subagent #2 (等待 Task 2, 3)
   │
   ↓
5. 工具执行 (Tool Execution)
   │
   ├─ PreToolUse Hook (前置检查)
   │   ├─ 权限验证
   │   ├─ 安全审计
   │   └─ 上下文注入
   │
   ├─ 实际工具调用
   │   ├─ File Operations
   │   ├─ Bash Commands
   │   ├─ Git Operations
   │   └─ MCP Tools
   │
   └─ PostToolUse Hook (后置处理)
       ├─ 日志记录
       ├─ 结果验证
       └─ 自动化测试
   │
   ↓
6. 结果聚合 (Result Aggregation)
   │
   ├─ 收集所有子代理输出
   ├─ 更新任务状态
   ├─ 生成用户响应
   └─ 更新上下文窗口
   │
   ↓
7. 用户反馈循环
```

---

## 1.3 工具系统设计

Claude Code 的工具系统采用**分层设计**，提供灵活性和安全性。

### 工具层级架构

```
┌─────────────────────────────────────────────────────────┐
│                    Tool Hierarchy                        │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  Level 1: Core Built-in Tools (核心内置工具)            │
│  ┌────────────────────────────────────────────────┐     │
│  │ - File Operations (Read, Write, Edit)          │     │
│  │ - Code Search (Glob, Grep)                     │     │
│  │ - Bash Execution                               │     │
│  │ - Git Operations                               │     │
│  │ - Task Management                              │     │
│  │ - Web (Search, Fetch)                          │     │
│  │                                                │     │
│  │ 特点: 总是可用，无需配置                       │     │
│  └────────────────────────────────────────────────┘     │
│                          ↓                               │
│  Level 2: Subagent-Specific Tools (子代理专用工具)      │
│  ┌────────────────────────────────────────────────┐     │
│  │ Explore: Read + Search (只读)                  │     │
│  │ General: All Tools (完整权限)                  │     │
│  │ Bash: Command Execution (命令行)               │     │
│  │                                                │     │
│  │ 特点: 根据代理类型限制访问                     │     │
│  └────────────────────────────────────────────────┘     │
│                          ↓                               │
│  Level 3: MCP Tools (扩展工具)                          │
│  ┌────────────────────────────────────────────────┐     │
│  │ - Database Access (PostgreSQL, MongoDB)        │     │
│  │ - External APIs (REST, GraphQL)                │     │
│  │ - Design Tools (Figma, Sketch)                 │     │
│  │ - Project Management (Jira, Linear)            │     │
│  │ - Custom Services                              │     │
│  │                                                │     │
│  │ 特点: 通过 MCP 协议集成，需要配置                │     │
│  └────────────────────────────────────────────────┘     │
│                          ↓                               │
│  Level 4: Permission-Gated Tools (权限受限工具)         │
│  ┌────────────────────────────────────────────────┐     │
│  │ - File Deletion                                │     │
│  │ - Destructive Bash Commands                    │     │
│  │ - Git Push/Force Operations                    │     │
│  │ - System Configuration                         │     │
│  │                                                │     │
│  │ 特点: 需要用户显式许可才能执行                  │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 工具访问矩阵

| 工具类型 | Explore | General | Bash | Plan Agent | Build Agent |
|---------|---------|---------|------|------------|-------------|
| **File Read** | ✓ | ✓ | - | ✓ | ✓ |
| **File Write** | ✗ | ✓ | ✓ | ✗ | ✓ |
| **File Delete** | ✗ | ✓ (需许可) | ✓ (需许可) | ✗ | ✓ (需许可) |
| **Code Search** | ✓ | ✓ | - | ✓ | ✓ |
| **Bash Execute** | ✗ | ✓ (需许可) | ✓ (需许可) | ✗ | ✓ (需许可) |
| **Git Read** | ✓ | ✓ | ✓ | ✓ | ✓ |
| **Git Write** | ✗ | ✓ (需许可) | ✓ (需许可) | ✗ | ✓ (需许可) |
| **Task Mgmt** | ✓ | ✓ | ✗ | ✓ | ✓ |
| **Web Search** | ✓ | ✓ | - | ✓ | ✓ |
| **Web Fetch** | ✓ | ✓ | - | ✓ | ✓ |
| **MCP Tools** | 视配置 | 视配置 | 视配置 | 视配置 | 视配置 |

### 工具调用流程

```
Tool Call Request
    │
    ↓
┌─────────────────────────────────┐
│   1. Permission Check            │
│   ├─ 检查代理类型权限            │
│   ├─ 检查运行模式权限            │
│   └─ 检查用户许可配置            │
└─────────────────────────────────┘
    │
    ├─→ 拒绝 → 返回错误
    │
    ↓ 允许
┌─────────────────────────────────┐
│   2. Hook: PreToolUse            │
│   ├─ 执行前置钩子                │
│   ├─ 上下文注入                  │
│   └─ 安全审计                    │
└─────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────┐
│   3. Tool Execution              │
│   ├─ 参数验证                    │
│   ├─ 实际执行                    │
│   └─ 结果捕获                    │
└─────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────┐
│   4. Hook: PostToolUse           │
│   ├─ 执行后置钩子                │
│   ├─ 日志记录                    │
│   └─ 自动化验证                  │
└─────────────────────────────────┘
    │
    ↓
┌─────────────────────────────────┐
│   5. Result Processing           │
│   ├─ 格式化输出                  │
│   ├─ 上下文更新                  │
│   └─ 返回给代理                  │
└─────────────────────────────────┘
```

---

## 1.4 权限管理策略

Claude Code 实现了**细粒度的权限系统**，平衡安全性和生产力。

### 四种运行模式

```
┌─────────────────────────────────────────────────────────┐
│                    Permission Modes                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. YOLO Mode (最大权限)                                 │
│  ┌────────────────────────────────────────────────┐     │
│  │ 启动: claude --yes                             │     │
│  │                                                │     │
│  │ 权限:                                          │     │
│  │ ✓ 所有文件操作（读/写/删除）                   │     │
│  │ ✓ 所有 Bash 命令（包括 rm -rf）                │     │
│  │ ✓ Git 操作（包括 push）                        │     │
│  │ ✓ 系统配置修改                                 │     │
│  │                                                │     │
│  │ 使用场景:                                      │     │
│  │ - 个人项目快速开发                             │     │
│  │ - 原型验证                                     │     │
│  │ - 信任的环境                                   │     │
│  │                                                │     │
│  │ ⚠️  风险: 无安全防护                           │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  2. Accepting Edits Mode (文件修改权限)                  │
│  ┌────────────────────────────────────────────────┐     │
│  │ 启动: claude --accepting-edits                 │     │
│  │                                                │     │
│  │ 权限:                                          │     │
│  │ ✓ 文件读写                                     │     │
│  │ ✗ Bash 命令 (需要确认)                         │     │
│  │ ✗ 文件删除 (需要确认)                          │     │
│  │ ✗ Git push (需要确认)                          │     │
│  │                                                │     │
│  │ 使用场景:                                      │     │
│  │ - 日常代码编写                                 │     │
│  │ - 重构和优化                                   │     │
│  │ - 团队协作项目                                 │     │
│  │                                                │     │
│  │ ✓ 平衡: 生产力 vs 安全性                       │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  3. Plan Mode (规划模式，只读)                           │
│  ┌────────────────────────────────────────────────┐     │
│  │ 启动: claude (然后 /plan 或 Shift+Tab)         │     │
│  │                                                │     │
│  │ 权限:                                          │     │
│  │ ✓ 文件读取                                     │     │
│  │ ✓ 代码搜索                                     │     │
│  │ ✓ Web 搜索                                     │     │
│  │ ✓ 任务管理                                     │     │
│  │ ✗ 文件修改                                     │     │
│  │ ✗ Bash 命令                                    │     │
│  │                                                │     │
│  │ 使用场景:                                      │     │
│  │ - 大型重构前的规划                             │     │
│  │ - 架构设计                                     │     │
│  │ - 影响范围分析                                 │     │
│  │                                                │     │
│  │ ✓ 审批后切换到 Accepting Edits 模式            │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
│  4. Default Mode (最小权限，需逐个确认)                  │
│  ┌────────────────────────────────────────────────┐     │
│  │ 启动: claude                                   │     │
│  │                                                │     │
│  │ 权限:                                          │     │
│  │ ✓ 文件读取                                     │     │
│  │ ? 其他所有操作需要确认                         │     │
│  │                                                │     │
│  │ 使用场景:                                      │     │
│  │ - 探索未知代码库                               │     │
│  │ - 高风险环境                                   │     │
│  │ - 学习和实验                                   │     │
│  │                                                │     │
│  │ ✓ 最安全，但交互频繁                           │     │
│  └────────────────────────────────────────────────┘     │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 权限配置示例

#### 基础配置 (`~/.claude/config.json`)

```json
{
  "permissions": {
    "mode": "accepting-edits",

    "allow": [
      {
        "tool": "Bash",
        "pattern": "npm run *",
        "description": "允许所有 npm scripts"
      },
      {
        "tool": "Bash",
        "pattern": "git commit *",
        "description": "允许 git 提交"
      },
      {
        "tool": "File",
        "pattern": "src/**/*.{js,ts,jsx,tsx}",
        "operations": ["read", "write"],
        "description": "允许源代码读写"
      }
    ],

    "deny": [
      {
        "tool": "Bash",
        "pattern": "rm -rf *",
        "description": "禁止递归删除"
      },
      {
        "tool": "Bash",
        "pattern": "git push --force *",
        "description": "禁止强制推送"
      },
      {
        "tool": "File",
        "pattern": ".env*",
        "operations": ["read", "write"],
        "description": "禁止访问环境变量文件"
      }
    ],

    "ask": [
      {
        "tool": "Bash",
        "pattern": "git push *",
        "description": "推送前需要确认"
      },
      {
        "tool": "File",
        "pattern": "package.json",
        "operations": ["write"],
        "description": "修改依赖前需要确认"
      }
    ]
  }
}
```

#### 项目级配置 (`.claude/config.json`)

```json
{
  "permissions": {
    "inherit": "user",

    "allow": [
      {
        "tool": "Bash",
        "pattern": "./scripts/build.sh",
        "description": "项目构建脚本"
      },
      {
        "tool": "Bash",
        "pattern": "docker-compose *",
        "description": "Docker 操作"
      }
    ],

    "deny": [
      {
        "tool": "File",
        "pattern": "secrets/**/*",
        "operations": ["read", "write", "delete"],
        "description": "禁止访问密钥目录"
      }
    ]
  }
}
```

---

## 1.5 架构设计理念

### 核心设计原则

#### 1. **职责分离 (Separation of Concerns)**

```
设计决策: 为什么需要多个代理类型？

传统方法 (单一代理):
  ├─ 单个 AI 处理所有任务
  ├─ 上下文混乱
  ├─ 难以并行化
  └─ 权限管理困难

Claude Code 方法 (多代理):
  ├─ Plan Agent: 专注分析和规划
  ├─ Build Agent: 专注执行和修改
  ├─ Explore Subagent: 专注搜索和理解
  ├─ General Subagent: 处理复杂任务
  └─ Bash Subagent: 优化命令执行

优势:
  ✓ 清晰的职责边界
  ✓ 更好的上下文管理
  ✓ 支持并行执行
  ✓ 细粒度权限控制
```

#### 2. **最小权限原则 (Principle of Least Privilege)**

```
设计理念: 默认拒绝，显式允许

实现:
  1. 每个代理类型有固定的工具访问权限
  2. 运行模式进一步限制权限范围
  3. 用户配置覆盖默认行为
  4. Hook 系统提供额外的安全检查

示例权限继承链:
  Subagent Type Permission
         ↓
  Running Mode Permission
         ↓
  User Configuration
         ↓
  Hook System Validation
         ↓
  Final Decision (Allow/Deny/Ask)
```

#### 3. **持久化优先 (Persistence First)**

```
设计目标: 长期运行的开发会话

实现机制:
  ├─ Task System: 跨会话任务持久化
  ├─ Session Resume: 完整上下文恢复
  ├─ Teleport: 跨平台会话迁移
  └─ Context Compaction: 智能历史压缩

传统 AI 助手:
  会话 1 → 丢失上下文 → 会话 2 → 重新开始

Claude Code:
  会话 1 → 保存状态 → 会话 2 → 无缝继续
           ↓
        任务系统持久化
           ↓
        其他会话也可访问
```

#### 4. **并行优先 (Parallelism First)**

```
设计假设: 现代开发任务高度并行化

实现策略:
  1. 最多 7 个并发子代理
  2. DAG 任务依赖管理
  3. 独立的代理上下文
  4. 异步任务执行

示例工作流:
  串行执行 (传统):
    分析 → 编码 → 测试 → 构建 → 部署
    总时间: 50 分钟

  并行执行 (Claude Code):
    ├─ 分析 (Explore) ─────────┐
    ├─ 单元测试 (General) ─────┤
    ├─ 集成测试 (General) ─────├─→ 构建 → 部署
    ├─ 类型检查 (Bash) ────────┤
    └─ Lint (Bash) ────────────┘
    总时间: 15 分钟
```

#### 5. **可观测性 (Observability)**

```
设计要求: 用户需要理解 AI 在做什么

实现:
  1. 详细的工具调用日志
  2. Hook 系统的审计能力
  3. 任务状态可视化
  4. 上下文使用监控 (/context 命令)

示例输出:
  ┌─────────────────────────────────┐
  │ Task: Implement Auth            │
  ├─────────────────────────────────┤
  │ Status: In Progress             │
  │ Agent: General Subagent #1      │
  │ Tools Used:                     │
  │   ✓ Read: src/auth.ts          │
  │   ✓ Write: src/auth.ts         │
  │   ⏳ Bash: npm test auth        │
  │                                 │
  │ Blocked By: None                │
  │ Blocking: [Task 4, Task 5]      │
  └─────────────────────────────────┘
```

### 架构优势总结

| 方面 | 传统 AI 助手 | Claude Code |
|-----|-------------|-------------|
| **会话长度** | 单次对话 | 无限会话（压缩） |
| **并行能力** | 串行执行 | 最多 7 个并发代理 |
| **任务持久化** | 无 | 跨会话 DAG 任务系统 |
| **权限管理** | 全有或全无 | 细粒度、多层级 |
| **上下文管理** | 手动清理 | 自动智能压缩 |
| **跨平台** | 无 | Web/IDE/CLI 互通 |
| **可扩展性** | 有限 | MCP + Skills |
| **自动化** | 无 | Hook 系统 |

---

## 下一步

- 深入了解 [上下文工程](./02-context-engineering.md)，理解无限对话的实现原理
- 学习 [Subagent 系统](./03-subagent-system.md)，掌握多代理协作
- 查看 [最佳实践](./08-best-practices.md)，优化你的工作流

---

**参考资源**:
- [Claude Code 官方文档](https://code.claude.com/docs)
- [拆解 Claude Code 架构真相](https://tonybai.com/2026/01/08/how-claude-code-works/)
- [重新定义 AI 编程协作](https://www.cnblogs.com/Chary/p/19312692)
